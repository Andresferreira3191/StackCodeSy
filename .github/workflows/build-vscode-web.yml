name: Download VSCode Web Server

# Download pre-built vscode-reh-web from official VSCode releases
# Much faster and more reliable than compiling from source

on:
  workflow_dispatch:
    inputs:
      vscode_version:
        description: 'VSCode version to download (e.g., 1.95.3)'
        required: true
        default: '1.95.3'
      quality:
        description: 'Quality (stable or insider)'
        required: true
        default: 'stable'

env:
  VSCODE_VERSION: ${{ github.event.inputs.vscode_version || '1.95.3' }}
  QUALITY: ${{ github.event.inputs.quality || 'stable' }}

jobs:
  download:
    name: Download vscode-reh-web
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download vscode-reh-web from official release
        run: |
          echo "Downloading vscode-reh-web v${{ env.VSCODE_VERSION }} for Linux x64..."

          # VSCode official download URL structure
          # https://update.code.visualstudio.com/{version}/server-linux-x64/stable

          DOWNLOAD_URL="https://update.code.visualstudio.com/${{ env.VSCODE_VERSION }}/server-linux-x64/${{ env.QUALITY }}"

          echo "Download URL: $DOWNLOAD_URL"

          # Download with progress
          curl -L "$DOWNLOAD_URL" -o vscode-server-linux-x64.tar.gz

          echo "Download completed!"
          ls -lh vscode-server-linux-x64.tar.gz

      - name: Extract and verify
        run: |
          echo "Extracting archive..."
          tar -xzf vscode-server-linux-x64.tar.gz

          echo "Contents:"
          ls -lah

          # The extracted folder is named vscode-server-linux-x64
          if [ -d "vscode-server-linux-x64" ]; then
            echo "✅ VSCode server extracted successfully"
            echo "Size: $(du -sh vscode-server-linux-x64 | cut -f1)"
            echo ""
            echo "Contents of server directory:"
            ls -lah vscode-server-linux-x64/
          else
            echo "❌ ERROR: Expected directory not found"
            ls -la
            exit 1
          fi

      - name: Repackage as vscode-reh-web
        run: |
          echo "Renaming for compatibility with StackCodeSy..."
          mv vscode-server-linux-x64 vscode-reh-web

          echo "Creating tarball..."
          tar -czf vscode-reh-web-linux-x64.tar.gz vscode-reh-web/

          echo "✅ Tarball created:"
          ls -lh vscode-reh-web-linux-x64.tar.gz

      - name: Test server binary
        run: |
          echo "Testing server binary..."
          cd vscode-reh-web

          if [ -f "bin/code-server" ]; then
            ./bin/code-server --version || echo "Version check completed"
            echo "✅ Server binary is executable"
          else
            echo "Available files:"
            find . -name "*server*" -o -name "*code*" | head -20
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-reh-web-linux-x64
          path: vscode-reh-web-linux-x64.tar.gz
          retention-days: 30

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VSCODE_VERSION }}-download-${{ github.run_number }}
          name: VSCode Web Server v${{ env.VSCODE_VERSION }} (Official Build)
          body: |
            # StackCodeSy - VSCode Web Server (Official Build)

            **VSCode Version:** ${{ env.VSCODE_VERSION }}
            **Build Type:** Official Microsoft pre-built binary
            **Download Date:** ${{ github.event.repository.updated_at }}
            **Platform:** Linux x64

            ## Source
            Downloaded from official VSCode update server:
            `https://update.code.visualstudio.com/${{ env.VSCODE_VERSION }}/server-linux-x64/stable`

            ## Usage

            ### Direct usage:
            ```bash
            # Download and extract
            tar -xzf vscode-reh-web-linux-x64.tar.gz
            cd vscode-reh-web

            # Run server
            ./bin/code-server --host 0.0.0.0 --port 8080 --without-connection-token
            ```

            ### For StackCodeSy Docker:
            Place this tarball in the root of your StackCodeSy repository:
            ```bash
            # Copy to project root
            cp vscode-reh-web-linux-x64.tar.gz /path/to/StackCodeSy/

            # Build and run
            cd /path/to/StackCodeSy
            docker-compose up -d --build
            ```

            ### Verify:
            Access the editor at `http://localhost:8889`

            ## Note
            This is the **official pre-built binary** from Microsoft, not compiled from source.
            - ✅ Faster to download (~2 minutes vs 50+ minutes compiling)
            - ✅ Guaranteed to work (official build)
            - ✅ Same binary used by `code-server` and VSCode remote
          files: vscode-reh-web-linux-x64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
